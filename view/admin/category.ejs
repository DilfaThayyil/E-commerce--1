<%-include('../partials/adminHeader')%>
<style>
.swal2-modal .swal2-title{
  color: green;
}
.swal2-modal .swal2-text{
  color: black;
}
</style>

    <div class="container-scroller">
      <!-- partial:partials/_sidebar.html -->
      <%-include('../partials/adminNavbar')%>

      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:partials/_navbar.html -->
        
        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">

            <div class="col-lg-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">All Categories</h4>
                  
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>No.</th>
                          <th>Name</th>
                          <th>Description</th>
                          <th>Offer</th>
                          <th>Edit</th>
                          <th>Status</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <%category.forEach((category,index)=>{%>
                          <tr>
                            <td><%=index+1%></td>
                            <td><%=category.Name%></td>
                            <td><%=category.Description%></td>
                            <td>
                              <% if(category.offer){%>
                                <p id="offer"><%=category.offer.name%></p>
                                <a href="#" class="btn btn-danger" id="remove" onclick="removeOffer('<%=category.offer._id%>','<%=category._id%>')">
                                  remove
                                </a>
                              <%}else{%>
                                <a href="" class="btn btn-success" data-toggle="modal" data-target="#offerModal<%=category._id%>">
                                  Apply
                                </a>
                              <%}%>

                              <div class="modal fade" id="offerModal<%=category._id%>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                  <div class="modal-content">
                                    <div class="modal-header">
                                      <h5 class="modal-title" id="exampleModalLabel" style="color: white;">Select Offer</h5>
        
                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                      <hr>
                                      <h3 style="color: whitesmoke;">Available Offers</h3>
                                      <% offers.forEach((offer)=>{%>
                                      <div class="row">
                                        <div class="col-sm-6">
                                          <div class="card">
                                            <div class="card-body">
                                              <h5 class="card-title">Name:<%=offer.name%></h5>
                                              <p class="card-text">Offer percentage:<%=offer.percentage%>%</p>
                                              <p class="card-text">StartingDate: <br> <%=offer.startDate.toLocaleDateString('en-US')%></p>
                                              <p class="card-text">ExpiryDate:  <br> <%=offer.endDate.toLocaleDateString('en-US')%></p>
                                              <button id="offerapply_<%=offer._id%>" onclick="applyOffer('<%=offer._id%>', '<%=category._id%>', 'offerapply_<%=offer._id%>')" class="btn btn-primary">Apply Offer</button>
                                              <br>
                                              <a href="#" style="display: none;" class="text-success" id="mesgoffer">Offer added</a>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                            
                                      <%})%>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                      <button type="button" class="btn btn-primary">Save changes</button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </td>
                            
                            <td><a class="btn btn-primary mr-2" href="/admin/editcategory/<%=category._id%>"><i class="mdi mdi-pencil"></i> Edit</a></td>

                            <%if(category.Status == 'active'){%>
                              <td><i class="text-success"><%=category.Status%></i></td>
                            <%}else{%>
                              <td><i class="text-danger"><%=category.Status%></i></td>
                            <%}%>
                            <%if(category.Status=='active'){%>
                            <td><a class="btn btn-danger" onclick="confirmBlock('<%= category._id %>')"><i class="mdi mdi-close-outline"></i> block </button></td>
                            <%}else{%>
                            <td><a class="btn btn-success" onclick="unblock('<%=category._id%>')">unblock</button></td>
                            <%}%>
                            <td>
                              <a onclick="deleteCategory('<%=category._id%>')"><i class="mdi mdi-delete" style="font-size: 20px; color: red;"></i></a>
                            </td>
                          </tr>
                        <%})%>
                      </tbody>
                    </table>
                  </div>

                  <div>
                    <a href="/admin/addcategory">
                      <button type="button" class="btn btn-primary btn-rounded btn-fw">Add Category</button>
                    </a>
                  </div>  

                </div>
              </div>
            </div>

          </div>
          <!-- content-wrapper ends -->
          <!-- partial:partials/_footer.html -->
          
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->
  <%-include('../partials/adminFooter')%>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    function confirmBlock(categoryId) {
      Swal.fire({
        title: 'Are you sure?',
        text: 'You are about to block this category!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, block it!'
      }).then((result) => {
        if (result.isConfirmed) {
          block(categoryId, 'block');
        }
      });
    }

    function unblock(categoryId) {
      Swal.fire({
        title: 'Are you sure?',
        text: 'You are about to unblock this category!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, unblock it!'
      }).then((result) => {
        if (result.isConfirmed) {
          block(categoryId, 'unblock');
        }
      });
    }
  
    function block(categoryId, action) {
      fetch(`/admin/blockcategory`, {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
        },
        body: JSON.stringify({ categoryId, action }),
      })
      .then(response => response.json())
      .then((data) => {
        if (data.success) {
          Swal.fire('Success!', 'Category has been blocked successfully.', 'success')
            .then(() => {
              window.location.reload();
            });
        } else {
          Swal.fire('Error!', 'Something went wrong. Please try again later.', 'error');
        }
      });
    }


    function applyOffer(offerId,categoryId){
      fetch('/admin/applyOfferCategory',{
            method:"POST",
            headers:{
              'Content-Type': 'application/json',
            },
            body:JSON.stringify({offerId,categoryId})
          }).then(response => response.json())
                .then(data => {
                  if(data.success){

                    window.location.reload()

                  }
                }).catch(error => console.error('Error:', error));
    }

    function removeOffer(offerId,categoryId){
            fetch('/admin/removeOfferCategory',{
              method:"POST",
              headers:{
                'Content-Type':'application/json'
              },
              body:JSON.stringify({offerId,categoryId})
            }).then(response=>response.json())
              .then((data)=>{
                if(data.success){

                  window.location.reload()
                }
            })
          }


    function deleteCategory(categoryId){
      Swal.fire({
        title: 'Are you sure?',
        text: 'You won\'t be able to revert this!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/admin/deleteCategory/${categoryId}`, {
            method: 'DELETE', 
            headers: {
              'Content-Type': 'application/json',
            },
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();

          })
          .then(data => {
            window.location.reload()
          })
          .catch(error => {
            console.error('Error:', error);
          });
        }
      });
    }


  </script>
  
  
  